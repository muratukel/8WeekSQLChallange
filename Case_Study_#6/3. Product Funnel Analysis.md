## üìå Case Study #6 - Clique Bait
## ‚úîÔ∏è 3. Product Funnel Analysis

## Using a single SQL query - create a new output table which has the following details:
‚û∞How many times was each product viewed?

‚û∞How many times was each product added to cart?

‚û∞How many times was each product added to a cart but not purchased (abandoned)?

‚û∞How many times was each product purchased?

 ```sql

with product_wiew_added as 
(
select 
	distinct e.visit_id,
	ph.product_id,
	ph.product_category,
	ph.page_name,
		sum(case 
		   		when ei.event_name ='Page View' then 1 else 0 end) as page_views,
		sum(case 
				when ei.event_name ='Add to Cart' then 1 else 0 end) as add_to_cart
from events as e 
left join page_hierarchy as ph on ph.page_id = e.page_id
	left join event_identifier as ei on ei.event_type = e.event_type
where ph.product_id is not null 
group by 1,2,3,4
),
purchase as 
(
select 
		distinct visit_id
	from events e 
	left join event_identifier as ei on ei.event_type = e.event_type
		where ei.event_name ='Purchase' and e.visit_id is not null
),
table3 as 
(
select 
		distinct pwa.visit_id,
				 pwa.product_id,
				 pwa.product_category,
			     pwa.page_name,
				 pwa.page_views,
				 pwa.add_to_cart,
		case when p.visit_id is not null then 1 else 0 end as purchase
	from product_wiew_added as pwa 
	left join purchase as p on p.visit_id =pwa.visit_id
),
table4 as 
(
select 
	product_id,
	page_name,
	product_category,
	sum(page_views) as view ,
	sum(add_to_cart) as add_cart,
	sum(case
	   		when add_to_cart = 1 and purchase = 0 then 1 else 0 end) as abandon,
	sum(case
	   		when add_to_cart = 1 and purchase = 1 then 1 else 0 end) as purchased
from table3 
	group by 1,2,3 
)
select * from table4
	order by product_id
```
| product_id | page_name       | product_category | view | add_cart | abandon | purchased |
|------------|-----------------|------------------|------|----------|---------|-----------|
| 1          | Salmon          | Fish             | 1559 | 938      | 227     | 711       |
| 2          | Kingfish        | Fish             | 1559 | 920      | 213     | 707       |
| 3          | Tuna            | Fish             | 1515 | 931      | 234     | 697       |
| 4          | Russian Caviar  | Luxury           | 1563 | 946      | 249     | 697       |
| 5          | Black Truffle   | Luxury           | 1469 | 924      | 217     | 707       |
| 6          | Abalone         | Shellfish        | 1525 | 932      | 233     | 699       |
| 7          | Lobster         | Shellfish        | 1547 | 968      | 214     | 754       |
| 8          | Crab            | Shellfish        | 1564 | 949      | 230     | 719       |
| 9          | Oyster          | Shellfish        | 1568 | 943      | 217     | 726       |

 ## Additionally, create another table which further aggregates the data for the above points but this time for each product category instead of individual products.
 ```sql
 with product_wiew_added as 
(
select 
	distinct e.visit_id,
	ph.product_id,
	ph.product_category,
	ph.page_name,
		sum(case 
		   		when ei.event_name ='Page View' then 1 else 0 end) as page_views,
		sum(case 
				when ei.event_name ='Add to Cart' then 1 else 0 end) as add_to_cart
from events as e 
left join page_hierarchy as ph on ph.page_id = e.page_id
	left join event_identifier as ei on ei.event_type = e.event_type
where ph.product_id is not null 
group by 1,2,3,4
),
purchase as 
(
select 
		distinct visit_id
	from events e 
	left join event_identifier as ei on ei.event_type = e.event_type
		where ei.event_name ='Purchase' and e.visit_id is not null
),
table3 as 
(
select 
		distinct pwa.visit_id,
				 pwa.product_id,
				 pwa.product_category,
			     pwa.page_name,
				 pwa.page_views,
				 pwa.add_to_cart,
		case when p.visit_id is not null then 1 else 0 end as purchase
	from product_wiew_added as pwa 
	left join purchase as p on p.visit_id =pwa.visit_id
),
table4 as 
(
select 
	product_category,
	sum(page_views) as view,
	sum(add_to_cart) as add_cart,
	sum(case
	   		when add_to_cart = 1 and purchase = 0 then 1 else 0 end) as abandon,
	sum(case
	   		when add_to_cart = 1 and purchase = 1 then 1 else 0 end) as purchased
from table3 
	group by 1
)
select * from table4
```

| product_category | view  | add_cart | abandon | purchased |
|------------------|-------|----------|---------|-----------|
| Luxury           | 3032  | 1870     | 466     | 1404      |
| Shellfish        | 6204  | 3792     | 894     | 2898      |
| Fish             | 4633  | 2789     | 674     | 2115      |

## Use your 2 new output tables 

```sql
CREATE TABLE product_new AS

(with product_wiew_added as 
(
select 
	distinct e.visit_id,
	ph.product_id,
	ph.product_category,
	ph.page_name,
		sum(case 
		   		when ei.event_name ='Page View' then 1 else 0 end) as page_views,
		sum(case 
				when ei.event_name ='Add to Cart' then 1 else 0 end) as add_to_cart
from events as e 
left join page_hierarchy as ph on ph.page_id = e.page_id
	left join event_identifier as ei on ei.event_type = e.event_type
where ph.product_id is not null 
group by 1,2,3,4
),
purchase as 
(
select 
		distinct visit_id
	from events e 
	left join event_identifier as ei on ei.event_type = e.event_type
		where ei.event_name ='Purchase' and e.visit_id is not null
),
table3 as 
(
select 
		distinct pwa.visit_id,
				 pwa.product_id,
				 pwa.product_category,
			     pwa.page_name,
				 pwa.page_views,
				 pwa.add_to_cart,
		case when p.visit_id is not null then 1 else 0 end as purchase
	from product_wiew_added as pwa 
	left join purchase as p on p.visit_id =pwa.visit_id
),
table4 as 
(
select 
	product_category,
	sum(page_views) as view,
	sum(add_to_cart) as add_cart,
	sum(case
	   		when add_to_cart = 1 and purchase = 0 then 1 else 0 end) as abandon,
	sum(case
	   		when add_to_cart = 1 and purchase = 1 then 1 else 0 end) as purchased
from table3 
	group by 1
)
select * from table4
	
	)
```
