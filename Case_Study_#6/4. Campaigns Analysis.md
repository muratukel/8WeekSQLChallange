## üìå Case Study #6 - Clique Bait

## ‚úîÔ∏è 4. Campaigns Analysis

## Generate a table that has 1 single row for every unique visit_id record and has the following columns:

````sql
select 
	distinct u.user_id,
	e.visit_id,
	min(e.event_time) as visit_start_time,
	sum(case 
	   		when ei.event_name='Page View' then 1 else 0 end ) as page_views,
	sum(case 
	   		when ei.event_name='Add to Cart' then 1 else 0 end ) as cart_adds,	
	sum(case 
	   		when ei.event_name='Purchase' then 1 else 0 end ) as purchase,
	ci.campaign_name,		
	sum(case 
	   		when ei.event_name='Ad Impression' then 1 else 0 end ) as impression,
	sum(case 
	   		when ei.event_name='Ad Click' then 1 else 0 end ) as click,	
	string_agg(case 
			  	when ph.product_id is not null and ei.event_name='Add to Cart' then ph.page_name else null end,
			  ', ' order by e.sequence_number) as cart_products 	
from users as u
left join events as e 
	on e.cookie_id=u.cookie_id
left join event_identifier as ei 
	on ei.event_type=e.event_type
left join page_hierarchy as ph
	on ph.page_id=e.page_id
left join campaign_identifier as ci
	on e.event_time between ci.start_date and ci.end_date
		group by 1,2,7
````
## Some ideas you might want to investigate further include:

# 1.Identifying users who have received impressions during each campaign period and comparing each metric with other users who did not have an impression event
````sql

WITH impressions AS (
    SELECT
         u.user_id,
        e.visit_id,
        MIN(e.event_time) AS visit_start_time,
        SUM(CASE WHEN ei.event_name = 'Page View' THEN 1 ELSE 0 END) AS page_views,
        SUM(CASE WHEN ei.event_name = 'Add to Cart' THEN 1 ELSE 0 END) AS cart_adds,
        SUM(CASE WHEN ei.event_name = 'Purchase' THEN 1 ELSE 0 END) AS purchase,
        ci.campaign_name,
        SUM(CASE WHEN ei.event_name = 'Ad Impression' THEN 1 ELSE 0 END) AS impression,
        SUM(CASE WHEN ei.event_name = 'Ad Click' THEN 1 ELSE 0 END) AS click,
        STRING_AGG(CASE WHEN ph.product_id IS NOT NULL AND ei.event_name = 'Add to Cart' THEN ph.page_name ELSE NULL END, ', ' ORDER BY e.sequence_number) AS cart_products
    FROM
        users AS u
    LEFT JOIN
        events AS e ON e.cookie_id = u.cookie_id
    LEFT JOIN
        event_identifier AS ei ON ei.event_type = e.event_type
    LEFT JOIN
        page_hierarchy AS ph ON ph.page_id = e.page_id
    LEFT JOIN
        campaign_identifier AS ci ON e.event_time BETWEEN ci.start_date AND ci.end_date
    GROUP BY
        u.user_id, e.visit_id, ci.campaign_name
)
SELECT
    i.user_id,
    i.campaign_name,
    SUM(CASE WHEN ei.event_name = 'Ad Impression' THEN 1 ELSE 0 END) AS impression_count,
    SUM(CASE WHEN ei.event_name <> 'Ad Impression' THEN 1 ELSE 0 END) AS non_impression_count,
    SUM(CASE WHEN ei.event_name = 'Ad Impression' THEN i.page_views ELSE 0 END) AS impression_page_views,
    SUM(CASE WHEN ei.event_name <> 'Ad Impression' THEN i.page_views ELSE 0 END) AS non_impression_page_views,
    SUM(CASE WHEN ei.event_name = 'Ad Impression' THEN i.cart_adds ELSE 0 END) AS impression_cart_adds,
    SUM(CASE WHEN ei.event_name <> 'Ad Impression' THEN i.cart_adds ELSE 0 END) AS non_impression_cart_adds,
    SUM(CASE WHEN ei.event_name = 'Ad Impression' THEN i.purchase ELSE 0 END) AS impression_purchase,
    SUM(CASE WHEN ei.event_name <> 'Ad Impression' THEN i.purchase ELSE 0 END) AS non_impression_purchase
FROM
    impressions AS i
LEFT JOIN
    events AS e ON e.visit_id = i.visit_id
LEFT JOIN
    event_identifier AS ei ON ei.event_type = e.event_type
LEFT JOIN
    campaign_identifier AS ci ON e.event_time BETWEEN ci.start_date AND ci.end_date
GROUP BY
    i.user_id, i.campaign_name;
````
